C-V2X Mode 4 Protocol Stack — Complete Workflow
=================================================

SENDER SIDE (Top to Bottom)
===========================

Layer 7: Application — Mode4App
---------------------------------
Files: src/apps/mode4App/Mode4App.cc, Mode4BaseApp.cc

- handleSelfMessage() fires every 100ms (scheduleAt(simTime() + 0.1, sendEvt))
- generateAndSendSPDU() builds a BSM with position/speed/heading, serializes to hex,
  signs with PQC (pqcdsa::sign), wraps everything into an SPDU packet with embedded
  Certificate
- Attaches FlowControlInfoNonIp (direction=D2D_MULTI, lcid=5, priority=1, nodeId,
  duration)
- Calls Mode4BaseApp::sendLowerPackets(spdu) which sends to lowerGateOut_


Layer 2c: PDCP/RRC — LtePdcpRrcUeD2D
---------------------------------------
File: src/stack/pdcp_rrc/layer/LtePdcpRrc.cc

- Receives on dataIn_ gate
- For NonIp flows (Mode 4): encapsulates the app packet into an LtePdcpPdu, attaches
  FlowControlInfo, assigns a connection ID (CID)
- Sends down to RLC via send(pkt, rlcSap_[OUT])


Layer 2b: RLC (UM) — LteRlcUm
--------------------------------
File: src/stack/rlc/um/LteRlcUm.cc

- handleUpperMessage() -> looks up/creates a UmTxQueue for this connection
- UmTxQueue::enque(pkt) -> performs segmentation/fragmentation if the PDU exceeds
  the allowed size
- Sends fragments down to MAC via send(pkt, down_[OUT])


Layer 2a: MAC — LteMacVUeMode4
---------------------------------
File: src/stack/mac/layer/LteMacVUeMode4.cc

This is where SPS (Semi-Persistent Scheduling) lives. The main loop runs every
1ms TTI via handleSelfMessage():

1. Grant check: If no valid schedulingGrant_ exists, calls macGenerateSchedulingGrant():
   - Creates LteMode4SchedulingGrant with priority, RRI (Resource Reservation Interval)
   - Calculates minimum subchannel count needed (iterates MCS x subchannel combos to
     find TBS >= packet size)
   - Sets C_resel (reselection counter): random in [5,15] for 100ms RRI, [10,30] for
     50ms, [25,75] for 20ms
   - Sends grant to PHY to trigger sensing-based CSR computation

2. CSR response (macHandleSps()): PHY returns candidate resources -> MAC picks one
   uniformly at random -> configures RB map, start time, subchannel allocation,
   adjacent/non-adjacent PSCCH/PSSCH placement

3. Periodic TX: Decrements periodCounter_ each TTI. When it hits 0:
   - Selects MCS for the PDU, constructs MAC PDU (macPduMake() -- pops SDUs from RLC
     buffer, encapsulates into LteMacPdu)
   - Sends grant + HARQ buffer content to PHY

4. SPS reselection: When expirationCounter_ reaches the last period:
   - With probability probResourceKeep_ (default 0.4): KEEP the resource, pick new
     C_resel
   - Otherwise: let grant expire -> next packet triggers full reselection

5. DCC: If packetDropping_ enabled and channel occupancy ratio > crLimit, packets
   are dropped


Layer 1: PHY — LtePhyVUeMode4
--------------------------------
File: src/stack/phy/layer/LtePhyVUeMode4.cc

- handleUpperMessage() receives the grant + MAC PDU
- SCI creation (createSCIMessage()): Encodes subchannel index + count into a RIV
  (Resource Indication Value) per 3GPP TS 36.213 14.1.1.4C, plus priority, RRI,
  MCS, retransmission info (32 bits total)
- SCI transmission (sendSciMessage()): Broadcasts SCI as LteAirFrame with
  frameType=SCIPKT on PSCCH (2 RBs)
- TB transmission: Broadcasts the MAC PDU as LteAirFrame on PSSCH (remaining RBs)
- Both sent via sendBroadcast(airframe) over the simulated wireless channel


================================================================================

RECEIVER SIDE (Bottom to Top)
=============================

Layer 1: PHY — LtePhyVUeMode4
--------------------------------
File: src/stack/phy/layer/LtePhyVUeMode4.cc

- handleAirFrame(): Filters frames >1500m away. Collects all frames arriving in
  the same TTI. Schedules d2dDecodingTimer_ at TTI end.
- storeAirFrame(): Computes RSRP, RSSI, SINR per band via the channel model.
  Separates into sciInfo_ (PSCCH) and tbInfo_ (PSSCH) buffers.
- decodeAirFrame() (at TTI end):
  - SCI decoding: Half-duplex check -> sensing probability (erf model at -90.5 dBm
    threshold) -> propagation + interference check via error_Mode4() -> if decoded,
    writes reservation info into sensing window subchannels
  - TB decoding: Correlates with decoded SCI (same source ID) -> propagation +
    interference check -> if decoded, sends MAC PDU upward via
    send(pkt, upperGateOut_)

Failure modes tracked:
  - sciFailedHalfDuplex    : Node was transmitting when SCI arrived
  - tbFailedDueToNoSCI     : No corresponding SCI found or SCI decode failed
  - tbFailedDueToProp      : Signal too weak (propagation failure)
  - tbFailedDueToInterference : SINR too low (interference failure)


Layer 2a: MAC — LteMacVUeMode4
---------------------------------
- fromPhy(): Inserts PDU into HARQ RX buffer (LteHarqBufferRxD2D)
- Next TTI: extractCorrectPdus() from HARQ buffers -> macPduUnmake() pops SDUs ->
  sendUpperPackets() to RLC


Layer 2b: RLC — LteRlcUm
---------------------------
- handleLowerMessage() -> UmRxQueue::defragment() reassembles fragments ->
  sendDefragmented() sends up to PDCP


Layer 2c: PDCP — LtePdcpRrcUeD2D
-----------------------------------
- toDataOut(): Decapsulates the inner app packet from LtePdcpPdu -> sends via
  dataOut_ to application


Layer 7: Application — Mode4App
----------------------------------
- handleLowerMessage(): Identifies packet type (CBR / IcaSpdu / SPDU) -> extracts
  BSM/ICA data -> performs PQC signature verification (pqcdsa::verify) -> emits
  statistics (delay, PDR, distance) -> logs to CSV


================================================================================

SENSING-BASED RESOURCE SELECTION (3GPP TS 36.213 Section 14.1.1.6)
===================================================================

Implemented in computeCSRs() in LtePhyVUeMode4.cc (line 711):

Selection Window: [T+T1, T+T2]  (T1=1ms, T2=maxLatency up to 100ms)

Step 1:  Enumerate all (subframe, subchannel) pairs that fit the grant's
         subchannel count within the selection window.

Step 2:  EXCLUDE subframes mapped to unsensed sensing window entries
         (half-duplex gaps, using RRI-based periodicity mapping).

Step 3:  EXCLUDE subframes where decoded SCI reservations show
         RSRP > threshold (priority-dependent, from ThresPSSCHRSRP table).
         Threshold in dBm = -128 + (threshold_index - 1) * 2.

Step 4:  If >80% of CSRs excluded, increase threshold by 3dB and repeat.
         This guarantees at least 20% of CSRs remain.

Step 5:  Rank remaining CSRs by lowest average RSSI (or RSRP) computed
         over the sensing window at RRI intervals.

Step 6:  Return best 20% to MAC. MAC picks one at random.


Sensing Window
--------------
- Circular buffer of 1000 subframes (1 second), each with numSubchannels
  Subchannel objects.
- Each Subchannel stores: RSRP/RSSI per band, decoded SCI reservation info
  (priority, RRI, frequency location, MCS), sensed/reserved flags.
- Updated every TTI via updateSubframe().
- When the UE transmits, all subchannels in that subframe are marked as
  sensed=false (half-duplex constraint).

Random Scheduling
-----------------
- When randomScheduling=true, computeRandomCSRs() generates all possible CSRs
  without any sensing-based exclusion, shuffles them, and returns to MAC.


================================================================================

CBR AND CONGESTION CONTROL
===========================

CBR Measurement — updateCBR() (every 100ms)
- Scans the last 100 subframes of the sensing window.
- For each subchannel that was sensed: if average RSSI > threshold, count as "busy."
- CBR = (busy subchannels) / (total sensed subchannels).
- Threshold RSSI = -112 + 2 * thresholdRSSI parameter (dBm).
- CBR packet is sent up PHY -> MAC -> PDCP -> App.

CBR-Based TX Parameter Adaptation (MAC layer)
- CBR value is mapped to a cbr-ConfigIndex based on upper/lower bounds from XML config.
- Each config index constrains: minMCS-PSSCH, maxMCS-PSSCH,
  minSubchannel-NumberPSSCH, maxSubchannel-NumberPSSCH, allowedRetxNumberPSSCH,
  allowedRRI, cr-Limit.

Channel Occupancy Ratio (CR) and Packet Dropping
- CR = (subchannels used in past 1000ms + future reservations) /
       (numSubchannels * 1000).
- If packetDropping=true and CR > crLimit, packets are dropped (DCC).


================================================================================

KEY PARAMETERS
==============

Parameter                          Default    Effect
---------------------------------  ---------  ------------------------------------------
subchannelSize                     5 RBs      Frequency granularity per subchannel
numSubchannels                     10         Total subchannels in bandwidth
probResourceKeep                   0.4        SPS keep probability at expiration
reselectAfter                      1          Missed TXs before forced reselection
pStep                              100        Sensing window = pStep*10 = 1000ms
selectionWindowStartingSubframe    1          T1 offset for selection window
adjacencyPSCCHPSSCH                true       Adjacent SCI/data placement
randomScheduling                   false      Bypass sensing entirely
thresholdRSSI                      configurable  RSSI threshold for CBR (-112+2*val dBm)
C_resel (reselection counter)      random     [5,15] for 100ms; [10,30] for 50ms;
                                              [25,75] for 20ms RRI


================================================================================

KEY FILES REFERENCE
===================

Application Layer:
  src/apps/mode4App/Mode4App.cc / .h
  src/apps/mode4App/Mode4BaseApp.cc / .h
  src/apps/mode4App/pqcdsa.cc / .h

PDCP/RRC Layer:
  src/stack/pdcp_rrc/layer/LtePdcpRrc.cc
  src/stack/pdcp_rrc/layer/LtePdcpRrcUeD2D.cc

RLC Layer:
  src/stack/rlc/um/LteRlcUm.cc

MAC Layer:
  src/stack/mac/layer/LteMacVUeMode4.cc / .h
  src/stack/mac/layer/LteMacBase.cc
  src/stack/mac/layer/LteMacUe.cc
  src/stack/mac/packet/LteSchedulingGrant.h (LteMode4SchedulingGrant)

PHY Layer:
  src/stack/phy/layer/LtePhyVUeMode4.cc / .h
  src/stack/phy/layer/LtePhyUeD2D.cc
  src/stack/phy/layer/Subchannel.h
  src/stack/phy/packet/SidelinkControlInformation.msg
  src/stack/phy/packet/SpsCandidateResources.h
  
  
